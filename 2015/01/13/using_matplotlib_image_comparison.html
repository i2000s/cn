<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="utf-8">
    <title>Testing whether your code produces the correct plots -- in Python and on Travis</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="How to use matplotlib's image_comparison decorator in your own project">
    <meta name="author" content="Xiaodong Qi">
    <!-- Le styles -->
   <link rel="stylesheet" type="text/css" href="http://fonts.googleapis.com/css?family=Quattrocento+Sans:bold,bolditalic,italic|Quattrocento+Sans">
   <link rel="stylesheet" type="text/css" href="http://fonts.googleapis.com/css?family=Rosario:bold,bolditalic,italic|Rosario">
    <link href="/assets/css/light.css" rel="stylesheet" type="text/css" id="stl" title="light">
    <link rel="stylesheet" type="text/css" href="/assets/css/style.css">
    <link href="/assets/css/syntax.css" rel="stylesheet" type="text/css" id="stl" title="light">

    <script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-46730871-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>

  </head>

  <body>

  
<!-- Navbar  ================================================== -->
<div class="navbar navbar-fixed-top">
  <div class="navbar-inner">
    <div class="container">
      <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </a>
      <a class="brand" href="/README.html">  <img style="float:right;" src="/assets/img/icon-info-circle-inverted.png" alt="info"></a>
      <div class="nav-collapse">
        <ul class="nav">
          <li>
          <a href="/index.html">Home</a></li>

          <li>
          <a href="/research.html">Research</a></li>

          <li>
          <a href="/pubs/index.html">Publications and Actities</a></li>

          <!-- <li>
          <a href="/noteblog.html">Blog</a></li> -->

          <!-- <li>
          <a href="http://i2000s.github.io/notebooks.html">Notebooks</a></li> -->

          <li>
          <a href="/community.html">Community</a></li>

          <!-- <li>
          <a href="http://i2000s.github.io/teaching.html">Learning</a></li> -->

          <!--<li>
          <a href="/tools.html">Tools</a></li>

          <li>
          <a href="/philosophy.html">Philosophy</a></li> -->

        </ul>
      </div><!--/.nav-collapse -->
       <form class="navbar-search pull-right" method="get" action="http://google.com/search">
         <input type="hidden" name="q" value="site:http://i2000s.github.io ">
         <input type="text" class="search-query" name="q">
         <button class="btn btn-mini" type="submit"><i class="icon-search"></i></button>
       </form>
     </div> <!-- /container -->
   </div> <!-- /navbar-inner -->
 </div> <!-- /navbar -->


  <div class="container"> <!-- Twitter bootstrap has all body content in a container -->

    <!-- Custom masthead (big titles) -->

<header class="jumbotron subhead">
    <h1 class="entry-title">Testing whether your code produces the correct plots -- in Python and on Travis</h1>
    <h3>How to use matplotlib's image_comparison decorator in your own project</h3>
</header>

      <div class="row">
        <div class="span7 offset1 post">
          <p>A few years ago I was introduced to the idea of testing the scientific code I write,
and now I am a huge fan of this approach.  It saves huge amounts of time and vastly
improves the quality of my research by helping me catch bugs early and often.
I use <a href="https://nose.readthedocs.org/en/latest/">nose</a> for automatically finding
and running all the tests.  I use <a href="https://travis-ci.org/">Travis</a> to
automatically run the tests every time I update the code -- or issue a pull
request -- on Github.</p>

<h1>Image regression tests</h1>

<p>Usually, I can test the output of a routine by comparing numbers (generally, by
taking norms of large arrays of numbers).  However, I also develop routines that
are used to visualize numerical output, using matplotlib and other Python plotting
tools.  Sometimes the numerical output is fine
but the visualization code breaks.  It&#39;s easy to write tests that just make sure
the visualization code still runs, and that perhaps check some assertions about the
properties of the resulting matplotlib objects in memory.  But that doesn&#39;t ensure that
the image still looks right.  How does one automatically check whether an image is
correct?</p>

<p>Obviously, <em>correct</em> in this case must refer to some reference image that you
produced once and whose correctness you confirmed by visual inspection.
In other words, I&#39;m talking about <em>regression testing</em>, which simply ensures that
things function as they did before.
To regresion test an image, you could write an image file and check whether it
is bitwise identical to the reference image.  But this is very problematic, since
running the same bit of matplotlib code on two different machines will often lead
to slightly different output, depending on the versions of other libraries that
are installed, the fonts available, etc.  Some more intelligent method of comparison
is needed.</p>

<h1>The image_comparison decorator</h1>

<p>Fortunately, the matplotlib developers have been grappling with these issues
for a long time and have a nice packaged solution, in the form of a Python
decorator <code>@image_comparison</code>, whose usage within matplotlib is
<a href="http://matplotlib.org/devel/testing.html">explained here</a>.
The decorator automatically deals with saving the test image and comparing it
to the reference image; all you do is add the decorator before your test
function.</p>

<p>Clearly, I thought, it would be great if I could use this decorator for image
testing in my own projects.  So I followed the instructions linked above, but
things didn&#39;t immediately work.  Apparently <a href="http://matplotlib.1069221.n5.nabble.com/Image-comparison-decorators-outside-matplotlib-td42215.html">others have had the same
experience</a>,
so I thought I&#39;d share what I had to do to get things working.</p>

<h1>Getting things to work locally</h1>

<p>The decorator makes a few assumptions that are based on the directory
structure of matplotlib&#39;s own test directories.  So you have two options:</p>

<ol>
<li>Make your project&#39;s test directory structure conform to matplotlib&#39;s.</li>
<li>Create a modified version of matplotlib&#39;s image_comparison decorator for
your own project.</li>
</ol>

<p>I went with option 1, since I generally prefer to outsource as much functionality
as reasonably possible.  I had to do the following:</p>

<ul>
<li>Your tests must live in a submodule named <code>tests</code>.  Thus if your package is named
<em>pystuff</em>, you might have your tests in <code>pystuff/tests/my_tests.py</code> and there should
be an <code>__init__.py</code> file in the <code>tests</code> directory (it can be just an empty file).</li>
<li>The baseline images should be in a directory <code>pystuff/tests/baseline_images/my_tests/</code>
(replace <code>my_tests</code> with the name of the file containing your tests).
Note that the image names are specified as arguments to the decorator.</li>
</ul>

<p>Once I did that the tests passed on my machine.  However, they didn&#39;t pass on Travis.</p>

<h1>Getting things to work on Travis</h1>

<p>I ran into two issues on Travis:</p>

<ol>
<li>Generating matplotlib figures on Travis with a backed that requires DISPLAY will
fail if it is not set.</li>
<li>Even if display is set, Travis may use a different backend than you do locally,
which may lead to test failure (e.g., because the images produced have different
numbers of pixels).</li>
</ol>

<p>Both of these are solved by ensuring that matplotlib uses the <em>agg</em> backend for the
tests (both locally and on Travis).  To set the backend to <em>agg</em>, just add the command</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">matplotlib</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s">&#39;agg&#39;</span><span class="p">)</span>
</code></pre></div>
<p>This line must be executed before you import <em>pylab</em> or <code>matplotlib.pyplot</code>.
This is very tricky if you are using nose, because nose actually imports every
file in your package during the test collection phase.  What I had to do to get
things to work (and the matplotlib package itself does the same!) is to put
a <code>tests.py</code> script in the top directory of my package.  This script has the
following contents:</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="c">#!/usr/bin/env python</span>

<span class="kn">import</span> <span class="nn">matplotlib</span>
<span class="kn">import</span> <span class="nn">nose</span>
<span class="n">matplotlib</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s">&#39;agg&#39;</span><span class="p">)</span>

<span class="n">nose</span><span class="o">.</span><span class="n">main</span><span class="p">()</span>
</code></pre></div>
<p>Instead of calling nosetests directly on Travis, I use the following in my <code>.travis.yml</code>
file:</p>
<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="l-Scalar-Plain">script</span><span class="p-Indicator">:</span>
  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">cd $HOME/build/my/package</span>
  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">python tests.py</span>
</code></pre></div>
<p>That&#39;s it!  Since examples are the best documentation, you can check out my
working setup <a href="https://github.com/ketch/griddle">here</a>.</p>

<h4>Note: this post was originally written by David Ketcheson and posted at <a href="http://www.davidketcheson.info/2015/01/13/using_matplotlib_image_comparison.html">http://www.davidketcheson.info/2015/01/13/using<em>matplotlib</em>image_comparison.html</a></h4>

<p>under the <a href="http://creativecommons.org/licenses/by/3.0/deed.en_US">Creative Commons Attribution 3.0 Unported License</a>.</p>

        </div>


        <!-- Custom sidebar -->      
        <div class="span3">
          <div class="sidebar">
            Posted on
<time pubdate datetime="2015-01-13T00:00:00+00:00"
      itemprop="datePublished">13 Jan 2015</time>.
<br />
          
            <p><a class="btn btn-mini" href='/2014/12/31/mapmyfitness_pandas.html'>previous</a>
          
          
            <a class="btn btn-mini" href='/2015/05/10/rock_solid_code.html'>next</a></p>
          


<br />
<p> <a class="btn btn-mini" href="https://github.com/i2000s/i2000s.github.io/commits/master/_posts">history</a></p>
<br />
<br />
<span itemprop="keywords">
            
              <a rel="tag" class="tag" href="/tags.html#python">#python</a>
              , 
            
              <a rel="tag" class="tag" href="/tags.html#matplotlib">#matplotlib</a>
              , 
            
              <a rel="tag" class="tag" href="/tags.html#testing">#testing</a>
              
            
</span>



         </div>
       </div>

      </div>
<div id="related">
  <h2>Related Posts</h2>
  <ul class="posts">
    
      <li><span>01 Dec 2014</span> &raquo; <a href="/2014/12/01/clawpack-20.html">Clawpack turns 20</a></li>
    
      <li><span>09 Dec 2014</span> &raquo; <a href="/2014/12/09/teaching_kids_to_program.html">How and why I'm teaching my kids to code</a></li>
    
      <li><span>29 May 2015</span> &raquo; <a href="/2015/05/29/automate_tests.html">Step 7 - Automate the tests</a></li>
    
  </ul>
</div>


      <!-- Disqus Comments -->
      <div class="row">
        <div class="span12">
            <div id="disqus_thread"></div>
            <script type="text/javascript">
                var disqus_shortname = 'qxd'; // required: replace example with your forum shortname
                /* * * DON'T EDIT BELOW THIS LINE * * */
                (function() {
                    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                    dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
                    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                })();
            </script>
            <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        </div>
      </div>

       <footer class="footer">
         <div class="span12">
            <div class="span5">

              <a href="mailto:i2000s@hotmail.com" onClick="recordOutboundLink(this, 'Outbound Links', 'email'); return false;"><img src="/assets/img/icon-email.png" alt="email"> </a>
              <a href="https://github.com/i2000s" onClick="recordOutboundLink(this, 'Outbound Links', 'Github'); return false;"><img src="/assets/img/icon-github.png" alt="github"> </a>
              <a href="https://plus.google.com/+XiaodongQi"><img src="/assets/img/icon-gplus.png" alt="G+"></a>
              <a href="http://scholar.google.com/citations?user=6FdqHlIAAAAJ&hl=en"><img src="/assets/img/icon-scholar.png" alt="G+"></a>
              <a href="https://twitter.com/i2000s"><img src="/assets/img/icon-twitter.png" alt="Twitter"></a>
              <a href="/atom.xml" onClick="recordOutboundLink(this, 'Outbound Links', 'RSS'); return false;"><img src="/assets/img/icon-rss.png" alt="feed"></a>
              <a href="http://physics.stackexchange.com/users/37682/xiaodong-qi"><img src="/assets/img/icon-stackoverflow.png" alt="Physics Stackexchange"></a>
              <div>
                <br><span> &nbsp; </span> <span><a href="/CV-XiaodongQi.pdf"> CV of Xiaodong Qi</a></span>
                <br><img alt="Creative Commons License" style="border-width:0" align="right" src="https://licensebuttons.net/l/by/3.0/88x31.png" />
                <span xmlns:dct="http://purl.org/dc/terms/" property="dct:title">This site</span> is licensed under the
                <a rel="license" href="https://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution License</a> or specified.
                <br>
              </div>
           </div>

           <div class="span4">
              <div class="span4 team-member" marge-top="-20px">
              <img class="img-responsive img-thumbnail img-circle" width="200px" alt="" src="/assets/img/qi2016.jpg" align="middle"></img>
           </div>

      </div>
      <div class="span12" align="center">
            <a rel="license" href="https://creativecommons.org/licenses/by/4.0/">
              <span align="center" margin-top="-10px">Copyright &copy; 2016 Xiaodong Qi. </span></a>
            <br>
      </div>

    </footer>
   </div><!-- /container -->

        <!-- Le javascript
    ================================================== -->

    <!-- Placed at the end of the document so the pages load faster -->
    <!-- JQuery, used on a few pages -->
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js" ></script>
    <script src="http://cdn.jsdelivr.net/jquery.mixitup/latest/jquery.mixitup.min.js"></script>
    <script src="/assets/js/mixitup-mine.js"></script>
    <!-- Equations using MathJax -->
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/x-mathjax-config"> MathJax.Hub.Config({ TeX: { equationNumbers: {autoNumber: "all"} } });       </script>
    <script type="text/x-mathjax-config"> MathJax.Hub.Config({ tex2jax: { inlineMath: [['$', '$'],['\\(','\\)'] ] } }); </script>
    <!-- Twitter Bootstrap Javascript -->
    <script src="/assets/js/bootstrap-collapse.js"></script> <!-- for collapsing navbar-->
    <!-- Unused Twitter Bootstrap Javascript
    <script src="http://i2000s.github.io/assets/js/bootstrap-dropdown.js"></script>
    <script src="http://i2000s.github.io/assets/js/google-code-prettify/prettify.js"></script>
    <script src="http://i2000s.github.io/assets/js/bootstrap-transition.js"></script>
    <script src="http://i2000s.github.io/assets/js/bootstrap-alert.js"></script>
    <script src="http://i2000s.github.io/assets/js/bootstrap-modal.js"></script>
    <script src="http://i2000s.github.io/assets/js/bootstrap-scrollspy.js"></script>
    <script src="http://i2000s.github.io/assets/js/bootstrap-tab.js"></script>
    <script src="http://i2000s.github.io/assets/js/bootstrap-tooltip.js"></script>
    <script src="http://i2000s.github.io/assets/js/bootstrap-popover.js"></script>
    <script src="http://i2000s.github.io/assets/js/bootstrap-button.js"></script>
    <script src="http://i2000s.github.io/assets/js/bootstrap-carousel.js"></script>
    <script src="http://i2000s.github.io/assets/js/bootstrap-typeahead.js"></script>
    <script src="http://i2000s.github.io/assets/js/application.js"></script>
    -->

  </body>
</html>

